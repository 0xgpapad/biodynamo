# Configuration file to generate snap packages

name:  biodynamo
version: '@BDM_VERSION@'
summary: A high-performance platform for large-scale biological simulations
description: |
   BioDynaMo makes it possible to easily create, run, and visualize 3D
   biological simulations. It makes use of the latest computing technologies to
   run simulations blazingly fast. Integrate existing biological models into
   your own, to set up complex simulations in no time.

grade: devel
confinement: classic

parts:
  biodynamo:
    plugin: dump
    source: @CMAKE_INSTALL_PREFIX@
    stage-packages:
       - g++-5
       - git
       - cmake
       - make
       - python3
       - libomp-dev

  run:
    plugin: dump
    source: bin

  root:
    plugin: dump
    source: https://cernbox.cern.ch/index.php/s/BbFptgxo2K565IS/download?path=%2F&files=root_v6.11.01_Linux-ubuntu16-x86_64-gcc5.4_263508429d.tar.gz
    prepare: mkdir -p dependencies/root && mv * dependencies/root 2>/dev/null ; true
    stage-packages:
      # missing ldd
      - libc-bin

  qt:
    plugin: dump
    source: https://cernbox.cern.ch/index.php/s/BbFptgxo2K565IS/download?path=%2F&files=Qt5.9.1_ubuntu16_gcc5.4.tar.gz
    prepare: mkdir -p dependencies/qt && mv * dependencies/qt 2>/dev/null ; true

  paraview:
    plugin: dump
    source: https://cernbox.cern.ch/index.php/s/BbFptgxo2K565IS/download?path=%2F&files=paraview-5.4_ubuntu16_gcc5.4_openmpi_qt5.9.1.tar.gz
    prepare: mkdir -p dependencies/paraview && mv * dependencies/paraview 2>/dev/null ; true
    stage-packages:
      - libopenmpi-dev
      - openmpi-bin
      - freeglut3-dev

environment:
  # $SNAP not pointing to current
  # therefore replaced $SNAP with /snap/biodynamo/current
  # root, extracted from root/bin/thisroot.sh
  DYLD_LIBRARY_PATH: /snap/biodynamo/current/dependencies/root/lib
  ROOTSYS: /snap/biodynamo/current/dependencies/root
  CMAKE_PREFIX_PATH: /snap/biodynamo/current/dependencies/root:/snap/biodynamo/current/cmake
  JUPYTER_PATH: /snap/biodynamo/current/dependencies/root/etc/notebook
  SHLIB_PATH: /snap/biodynamo/current/dependencies/root/lib
  LIBPATH: /snap/biodynamo/current/dependencies/root/lib
  PYTHONPATH: /snap/biodynamo/current/dependencies/root/lib
  MANPATH: /snap/biodynamo/current/dependencies/root/man
  # Paraview
  ParaView_DIR: /snap/biodynamo/current/dependencies/paraview/lib/cmake/paraview-5.4
  Qt5_DIR: /snap/biodynamo/current/dependencies/qt/lib/cmake/Qt5
  PYTHONPATH: /snap/biodynamo/current/dependencies/paraview/lib/paraview-5.4/site-packages:/snap/biodynamo/current/dependencies/paraview/lib/paraview-5.4/site-packages/vtk
  QT_QPA_PLATFORM_PLUGIN_PATH: /snap/biodynamo/current/dependencies/qt/plugins
  # General
  LD_LIBRARY_PATH:    /snap/core/current/lib:/snap/core/current/lib64:/snap/core/current/usr/lib:/snap/core/current/lib/x86_64-linux-gnu:/snap/core/current/usr/lib/x86_64-linux-gnu:/snap/biodynamo/current/lib:/snap/biodynamo/current/usr/lib:/snap/biodynamo/current/lib/x86_64-linux-gnu:/snap/biodynamo/current/usr/lib/x86_64-linux-gnu:/snap/biodynamo/current/dependencies/root/lib:/snap/biodynamo/current/dependencies/qt/lib:/snap/biodynamo/current/usr/lib/openmpi/lib:/snap/biodynamo/current/dependencies/paraview/lib/paraview-5.4:$LD_LIBRARY_PATH
  PATH: /snap/biodynamo/current/dependencies/root/bin:/snap/biodynamo/current/dependencies/paraview/bin:$PATH
  CC: /snap/biodynamo/current/usr/bin/gcc-5
  CXX: /snap/biodynamo/current/usr/bin/g++-5

apps:
  # script that must be sourced to set the environment outside this snap
  getenv:
    command: biodynamo/bin/get-biodynamo-env-path.sh

  paraview:
    command: dependencies/paraview/bin/paraview

  root:
    command: dependencies/root/bin/root

  run:
    command: ./run

  cmake:
    command: usr/bin/cmake
  make:
    command: usr/bin/make
